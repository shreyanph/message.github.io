<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Message Board</title>
    <style>
        /* PAGE CONTAINER (kept to original width) */
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;               /* restored original width */
            margin: 40px auto;
            color: #ffffff;
            background-image: url("https://scx1.b-cdn.net/csz/news/800a/2023/data-science.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        /* small helper container so absolute button positions relative to page area */
        .page-inner {
            position: relative;
        }

        h2 {
            margin-bottom: 10px;
            color: #ffffff;
        }

        input, textarea, select {
            width: 100%;
            box-sizing: border-box;
            color: #ffffff;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(255,255,255,0.25);
            padding: 8px;
        }

        textarea { height: 80px; resize: vertical; }

        button {
            margin-top: 10px;
            color: #ffffff;
            background: rgba(0,0,0,0.65);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 12px;
            cursor: pointer;
        }

        .message {
            border-radius: 999px;
            padding: 10px 16px;
            margin: 6px 0;
            color: #ffffff;
            display: block;
            width: fit-content;
            max-width: 100%;
        }

        .divider {
            border-bottom: 1px solid rgba(255,255,255,0.25);
            margin: 8px 0;
        }

        .name {
            font-weight: bold;
            margin-right: 6px;
            color: #ffffff;
        }

        #messages { margin-top: 10px; }

        #messages, input, textarea, select { backdrop-filter: blur(2px); }

        /* Timestamp row: two thin lines with time centered */
        .timestamp-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            color: #ffffff;
            font-size: 0.9em;
        }
        .timestamp-row .line {
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.18);
        }
        .timestamp-row .timestamp-text {
            white-space: nowrap;
            padding: 0 6px;
            color: #ffffff;
            opacity: 0.95;
            font-size: 0.95em;
        }

        /* How To Use button (top-left inside the page container) */
        #howBtn {
            position: absolute;
            top: -12px; /* nudged up so it sits slightly above the Name List heading */
            left: -160px; /* moved much further left as requested */
            z-index: 30;
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 6px 10px;
            border-radius: 6px;
            pointer-events: auto;
        }

        /* Emoji row and picker */
        .emoji-row {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            position: relative; /* picker positioned relative to this */
        }
        .emoji-row textarea {
            /* override the global 100% width so textarea flexes with button */
            width: auto;
            flex: 1 1 auto;
        }
        #emojiBtn {
            min-width: 44px;
            height: 44px;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 18px;
            line-height: 1;
        }
        .emoji-picker {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: rgba(0,0,0,0.95);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 8px;
            border-radius: 8px;
            z-index: 200;
            width: max-content;
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
        }
        .emoji-btn {
            background: transparent;
            border: none;
            font-size: 20px;
            padding: 6px;
            cursor: pointer;
            border-radius: 6px;
        }
        .emoji-btn:hover {
            background: rgba(255,255,255,0.06);
        }

        /* Modal / panel for How To Use */
        .how-modal-backdrop {
            display: none; /* shown when active */
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .how-modal {
            max-width: 560px;
            width: 100%;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 16px;
            border-radius: 8px;
            color: #fff;
            box-shadow: 0 6px 30px rgba(0,0,0,0.6);
            position: relative;
        }
        .how-modal h3 { margin-top:0; }
        .how-modal .close {
            position: absolute;
            right: 8px;
            top: 8px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
        }

        /* Login overlay (GDM3-like) */
        #loginOverlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            background: rgba(0,0,0,0.55); /* keep background visible but dimmed */
        }
        .login-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            background: rgba(0,0,0,0.65);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 26px 28px;
            border-radius: 12px;
            min-width: 320px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }
        .avatar {
            width: 112px;
            height: 112px;
            border-radius: 50%;
            background: rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #fff;
            border: 2px solid rgba(255,255,255,0.06);
        }
        .login-title {
            font-size: 18px;
            color: #fff;
            opacity: 0.95;
        }
        .user-button {
            width: 260px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            border-radius: 10px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            color: #fff;
            cursor: pointer;
            font-size: 16px;
        }
        .user-button:hover {
            background: rgba(255,255,255,0.06);
        }

        /* Responsive fallback */
        @media (max-width: 640px) {
            body { margin: 20px; max-width: 100%; }
            /* revert button position on small screens so it doesn't go offscreen */
            #howBtn { left: 8px; top: 8px; }
            .emoji-picker { right: 0; left: 0; width: auto; }
            .emoji-grid { grid-template-columns: repeat(6, 1fr); }
            .login-card { min-width: 260px; padding: 18px; }
            .user-button { width: 220px; }
        }
    </style>
</head>
<body>
  <!-- LOGIN OVERLAY: shown first. Background remains visible beneath -->
  <div id="loginOverlay" role="dialog" aria-modal="true" aria-label="Login">
    <div class="login-card" role="presentation">
      <div class="avatar" aria-hidden="true">A</div>
      <div class="login-title">Select a user to sign in</div>

      <!-- Administrator user button (press to continue) -->
      <button id="adminBtn" class="user-button" type="button" aria-label="Sign in as Administrator">
        <span style="font-weight:700;">Administrator</span>
      </button>
      <div style="font-size:0.85em; color:rgba(255,255,255,0.75);">Click the account to continue</div>
    </div>
  </div>

  <div class="page-inner">
    <!-- How To Use button at top-left -->
    <button id="howBtn" title="How To Use">How To Use</button>

    <!-- Name List (original centred position) -->
    <h2>Name List</h2>
    <p style="margin-top:0;margin-bottom:6px;">
        Type each name on its own line:
    </p>
    <textarea id="nameListInput" placeholder="Alice
Bob
Charlie"></textarea>
    <br>
    <button id="saveNamesBtn">Save Names</button>

    <h2 style="margin-top:20px;">Message Board</h2>

    <select id="nameSelect" required>
        <option value="" disabled selected>Select a name</option>
    </select>
    <br><br>

    <!-- emoji-row: textarea + emoji button + picker -->
    <div class="emoji-row" id="emojiRow">
      <textarea id="messageInput" placeholder="Type a message..."></textarea>

      <!-- emoji button (opens picker) -->
      <button id="emojiBtn" type="button" title="Insert emoji">ðŸ˜Š</button>

      <!-- emoji picker -->
      <div id="emojiPicker" class="emoji-picker" aria-hidden="true">
        <div class="emoji-grid" id="emojiGrid">
          <!-- buttons inserted by JS -->
        </div>
      </div>
    </div>

    <br>
    <button id="sendBtn">Send</button>

    <h2>Message History</h2>
    <button id="clearBtn">Clear Message History (cloud)</button>

    <div id="messages"></div>
  </div>

  <!-- How To Use modal (hidden by default) -->
  <div id="howBackdrop" class="how-modal-backdrop" role="dialog" aria-modal="true">
    <div class="how-modal" role="document">
      <button class="close" id="howClose" aria-label="Close">&times;</button>
      <h3>How To Use</h3>
      <ol>
        <li><u>1 person</u> should enter the names of all users who shall use this messaging platform and save it to the cloud using the "Save Names" button.</li>
        <li>Each user should then use the dropdown menu in the "Message Board" section and select <u>their</u> name.</li>
        <li>Each user can now use the text box below to send messages to one another, with auto generated separators &amp; timestamps.</li>
      </ol>
      <p>Thank you for using <em>Message Board</em>!</p>
    </div>
  </div>

  <!-- Firebase v12 modular SDK (script type=module) -->
  <script type="module">
    // Firebase imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot,
      setDoc,
      doc,
      deleteDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ---------- Paste your firebaseConfig object here (from Firebase console) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDP7gvu9KT8u37wNEFJ1BUPBBxGKiIUEo8",
      authDomain: "message-history-2d3ab.firebaseapp.com",
      projectId: "message-history-2d3ab",
      storageBucket: "message-history-2d3ab.firebasestorage.app",
      messagingSenderId: "258209489466",
      appId: "1:258209489466:web:fae16998d2b8c161e6cb03",
      measurementId: "G-X3LTVS01X8"
    };
    // -------------------------------------------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM refs
    const nameListInput = document.getElementById('nameListInput');
    const saveNamesBtn = document.getElementById('saveNamesBtn');
    const nameSelect = document.getElementById('nameSelect');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const messagesDiv = document.getElementById('messages');

    // How-To modal refs
    const howBtn = document.getElementById('howBtn');
    const howBackdrop = document.getElementById('howBackdrop');
    const howClose = document.getElementById('howClose');

    // Emoji refs
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');
    const emojiRow = document.getElementById('emojiRow');

    // LOGIN overlay refs + initial hide of page-inner
    const loginOverlay = document.getElementById('loginOverlay');
    const adminBtn = document.getElementById('adminBtn');
    const pageInner = document.querySelector('.page-inner');
    // hide the message-board UI until login
    pageInner.style.display = 'none';

    // Make the How-To button hookup robust (ensure handlers are attached after elements exist)
    window.addEventListener('load', () => {
      // LOGIN: When Administrator is pressed, hide overlay and show page content
      adminBtn.addEventListener('click', () => {
        loginOverlay.style.display = 'none';
        pageInner.style.display = ''; // restore display
        // focus first control for convenience
        const select = document.getElementById('nameSelect');
        if (select) select.focus();
      });

      howBtn.addEventListener('click', () => {
        howBackdrop.style.display = 'flex';
      });
      howClose.addEventListener('click', () => {
        howBackdrop.style.display = 'none';
      });
      howBackdrop.addEventListener('click', (e) => {
        if (e.target === howBackdrop) howBackdrop.style.display = 'none';
      });

      // --- Emoji picker setup (only UI/behavior added) ---
      const emojis = [
        "ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ˜‚","ðŸ™‚",
        "ðŸ˜‰","ðŸ˜Š","ðŸ˜","ðŸ˜Ž","ðŸ¤”","ðŸ™","ðŸ‘","ðŸ‘€",
        "ðŸŽ‰","ðŸ”¥","ðŸ’€","ðŸ˜­","ðŸ˜œ","ðŸ¤©","ðŸ˜‡","ðŸ¤–",
        "ðŸ«¶","ðŸ˜´","ðŸ¤","ðŸ‘","ðŸ¤·","ðŸ™Œ","ðŸ’¯","âœ¨"
      ];

      // populate grid
      emojis.forEach(e => {
        const b = document.createElement('button');
        b.type = 'button';
        b.className = 'emoji-btn';
        b.textContent = e;
        b.addEventListener('click', (ev) => {
          ev.preventDefault();
          insertEmojiAtCursor(messageInput, e);
          // keep picker open for quick multi-insert; comment next line if you want it to stay open
          emojiPicker.style.display = 'none';
          emojiPicker.setAttribute('aria-hidden', 'true');
          // focus back to textarea
          messageInput.focus();
        });
        emojiGrid.appendChild(b);
      });

      // toggle picker
      emojiBtn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const open = emojiPicker.style.display === 'block';
        if (open) {
          emojiPicker.style.display = 'none';
          emojiPicker.setAttribute('aria-hidden', 'true');
        } else {
          emojiPicker.style.display = 'block';
          emojiPicker.setAttribute('aria-hidden', 'false');
        }
      });

      // click outside closes picker
      document.addEventListener('click', (e) => {
        if (!emojiRow.contains(e.target)) {
          emojiPicker.style.display = 'none';
          emojiPicker.setAttribute('aria-hidden', 'true');
        }
      });

      // keyboard: Esc closes picker
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          emojiPicker.style.display = 'none';
          emojiPicker.setAttribute('aria-hidden', 'true');
        }
      });
    });

    // insert emoji at caret position in textarea
    function insertEmojiAtCursor(textarea, emoji) {
      const start = textarea.selectionStart || 0;
      const end = textarea.selectionEnd || 0;
      const val = textarea.value;
      textarea.value = val.slice(0, start) + emoji + val.slice(end);
      const pos = start + emoji.length;
      textarea.selectionStart = textarea.selectionEnd = pos;
      // trigger input event in case anything listens
      textarea.dispatchEvent(new Event('input', { bubbles: true }));
    }

    // color palette
    const colors = [
      'rgba(0, 180, 0, 0.7)',     // Green
      'rgba(255, 165, 0, 0.85)',  // Orange
      'rgba(220, 20, 60, 0.85)',  // Red
      'rgba(128, 0, 128, 0.85)',  // Purple
      'rgba(255, 0, 255, 0.85)'   // Magenta
    ];

    // ---------- Utilities ----------
    function parseNames(raw) {
      return [...new Set(raw.split(/\r?\n|,/).map(s => s.trim()).filter(Boolean))];
    }

    // deterministic name -> color via hash so every device sees same mapping
    function hashStringToIndex(s, mod) {
      let h = 5381;
      for (let i = 0; i < s.length; i++) {
        h = ((h << 5) + h) + s.charCodeAt(i);
        h = h & 0xffffffff;
      }
      return Math.abs(h) % mod;
    }
    function colorForName(name) {
      const idx = hashStringToIndex(name.toLowerCase(), colors.length);
      return colors[idx];
    }

    function formatTimestamp(thing) {
      if (!thing) return "";
      // thing might be Firestore Timestamp, ISO string, or Date
      let d;
      if (typeof thing === 'string') d = new Date(thing);
      else if (thing && typeof thing.toDate === 'function') d = thing.toDate();
      else if (thing instanceof Date) d = thing;
      else d = new Date();
      if (isNaN(d)) return "";
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const year = d.getFullYear();
      let hour = d.getHours();
      const minute = d.getMinutes().toString().padStart(2, '0');
      const ampm = hour >= 12 ? 'PM' : 'AM';
      hour = hour % 12;
      if (hour === 0) hour = 12;
      return `${month}/${day}/${year} ${hour}:${minute} ${ampm}`;
    }

    // -------------------- Names (meta/names doc) --------------------
    const namesDocRef = doc(db, 'meta', 'names');

    // realtime listener for names (falls back to localStorage if not present)
    onSnapshot(namesDocRef, snap => {
      if (snap.exists()) {
        const data = snap.data();
        if (data && Array.isArray(data.list)) {
          populateNames(data.list);
          if (!nameListInput.value) nameListInput.value = data.list.join("\n");
        }
      } else {
        const local = JSON.parse(localStorage.getItem('names') || 'null');
        if (Array.isArray(local)) populateNames(local);
      }
    }, err => {
      const local = JSON.parse(localStorage.getItem('names') || 'null');
      if (Array.isArray(local)) populateNames(local);
    });

    saveNamesBtn.addEventListener('click', async () => {
      const names = parseNames(nameListInput.value || "");
      try {
        await setDoc(namesDocRef, { list: names });
        localStorage.setItem('names', JSON.stringify(names));
      } catch (err) {
        alert("Failed to save names to cloud: " + err.message);
      }
    });

    function populateNames(names) {
      localStorage.setItem('names', JSON.stringify(names));
      nameSelect.innerHTML = "";
      const placeholder = document.createElement('option');
      placeholder.value = "";
      placeholder.disabled = true;
      placeholder.selected = true;
      placeholder.textContent = "Select a name";
      nameSelect.appendChild(placeholder);
      names.forEach(n => {
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        nameSelect.appendChild(opt);
      });
    }

    // -------------------- Messages (collection: messages) --------------------
    const messagesCol = collection(db, 'messages');
    const messagesQuery = query(messagesCol, orderBy('time', 'asc'));

    // realtime listener for messages
    onSnapshot(messagesQuery, snapshot => {
      const msgs = [];
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        msgs.push({
          id: docSnap.id,
          name: d.name,
          text: d.text || "",
          time: d.time || null
        });
      });
      renderMessages(msgs);
    }, err => {
      console.error("Realtime messages error:", err);
    });

    // Render messages such that each timestamp separates authors and corresponds to the block BELOW it
    function renderMessages(messages) {
      messagesDiv.innerHTML = "";
      if (messages.length === 0) return;

      // Top timestamp corresponds to the first message's time (labels the block below)
      const topTime = formatTimestamp(messages[0].time);
      messagesDiv.appendChild(createTimestampRow(topTime));

      messages.forEach((m, i) => {
        const div = document.createElement('div');
        div.className = 'message';
        div.style.background = colorForName(m.name);

        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.textContent = m.name + ': ';

        div.appendChild(nameSpan);
        div.appendChild(document.createTextNode(m.text));
        messagesDiv.appendChild(div);

        // If next message author differs, insert timestamp that corresponds to the messages below (use next message's time)
        if (i < messages.length - 1 && messages[i].name !== messages[i + 1].name) {
          const nextTime = formatTimestamp(messages[i + 1].time);
          messagesDiv.appendChild(createTimestampRow(nextTime));
        }
      });

      if (messagesDiv.lastElementChild) {
        messagesDiv.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }
    }

    function createTimestampRow(text) {
      const row = document.createElement('div');
      row.className = 'timestamp-row';
      const left = document.createElement('div'); left.className = 'line';
      const mid = document.createElement('div'); mid.className = 'timestamp-text'; mid.textContent = text || '';
      const right = document.createElement('div'); right.className = 'line';
      row.appendChild(left); row.appendChild(mid); row.appendChild(right);
      return row;
    }

    // -------------------- Retention: auto-clear to keep last 10 if total > 100 --------------------
    async function enforceRetention() {
      try {
        const snap = await getDocs(messagesQuery);
        const total = snap.size;
        if (total > 100) {
          const numToDelete = total - 10;
          // snap.docs is ordered ascending by time due to messagesQuery
          const docsToDelete = snap.docs.slice(0, numToDelete);
          const deletes = docsToDelete.map(d => deleteDoc(doc(db, 'messages', d.id)));
          await Promise.all(deletes);
        }
      } catch (err) {
        console.error('Retention enforcement failed:', err);
      }
    }

    // -------------------- Add message --------------------
    sendBtn.addEventListener('click', addMessage);
    messageInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        addMessage();
      }
    });

    async function addMessage() {
      const name = (nameSelect.value || "").trim();
      const text = (messageInput.value || "").trim();
      if (!name || !text) return;
      try {
        await addDoc(messagesCol, {
          name,
          text,
          time: serverTimestamp()
        });
        messageInput.value = "";
        // enforce retention right after adding a new message
        await enforceRetention();
      } catch (err) {
        alert("Failed to send message: " + err.message);
      }
    }

    // -------------------- Clear messages (cloud) --------------------
    clearBtn.addEventListener('click', async () => {
      if (!confirm("Delete all messages from cloud? This cannot be undone.")) return;
      try {
        const snap = await getDocs(messagesCol);
        const deletes = [];
        snap.forEach(d => deletes.push(deleteDoc(doc(db, 'messages', d.id))));
        await Promise.all(deletes);
      } catch (err) {
        alert("Failed to clear messages: " + err.message);
      }
    });

    // -------------------- Bootstrap: use local names as fallback --------------------
    (function init() {
      const localNames = JSON.parse(localStorage.getItem('names') || 'null');
      if (Array.isArray(localNames) && (!nameListInput.value)) {
        nameListInput.value = localNames.join("\n");
      }
      if (Array.isArray(localNames)) populateNames(localNames);
      // Firestore onSnapshot listeners will override/populate when cloud doc exists
    })();
  </script>

</body>
</html>
