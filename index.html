<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Message Board</title>
    <style>
        /* PAGE BACKGROUND: full viewport so login overlay/background fills screen */
        body {
            font-family: Arial, sans-serif;
            min-height: 100vh;
            margin: 0;
            color: #ffffff;
            background-image: url("https://scx1.b-cdn.net/csz/news/800a/2023/data-science.jpg");
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }

        /* center content area (replaces previous body max-width) */
        .page-inner {
            position: relative;
            max-width: 600px;
            margin: 40px auto;
            padding: 12px;
            box-sizing: border-box;
        }

        h2 {
            margin-bottom: 10px;
            color: #ffffff;
        }

        input, textarea, select {
            width: 100%;
            box-sizing: border-box;
            color: #ffffff;
            background: rgba(0,0,0,0.55);
            border: 1px solid rgba(255,255,255,0.25);
            padding: 8px;
        }

        textarea { height: 80px; resize: vertical; }

        button {
            margin-top: 10px;
            color: #ffffff;
            background: rgba(0,0,0,0.65);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 8px 12px;
            cursor: pointer;
        }

        .message {
            border-radius: 999px;
            padding: 10px 16px;
            margin: 6px 0;
            color: #ffffff;
            display: block;
            width: fit-content;
            max-width: 100%;
        }

        .divider {
            border-bottom: 1px solid rgba(255,255,255,0.25);
            margin: 8px 0;
        }

        .name {
            font-weight: bold;
            margin-right: 6px;
            color: #ffffff;
        }

        #messages { margin-top: 10px; }

        #messages, input, textarea, select { backdrop-filter: blur(2px); }

        /* Timestamp row: two thin lines with time centered */
        .timestamp-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 8px 0;
            color: #ffffff;
            font-size: 0.9em;
        }
        .timestamp-row .line {
            flex: 1;
            height: 1px;
            background: rgba(255,255,255,0.18);
        }
        .timestamp-row .timestamp-text {
            white-space: nowrap;
            padding: 0 6px;
            color: #ffffff;
            opacity: 0.95;
            font-size: 0.95em;
        }

        /* How To Use button (top-left inside the page container) */
        #howBtn {
            position: absolute;
            top: -12px;
            left: -160px;
            z-index: 30;
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.15);
            padding: 6px 10px;
            border-radius: 6px;
            pointer-events: auto;
        }

        /* Emoji row and picker */
        .emoji-row {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            position: relative;
        }
        .emoji-row textarea { width: auto; flex: 1 1 auto; }
        #emojiBtn { min-width: 44px; height: 44px; padding: 6px 10px; border-radius: 8px; font-size: 18px; line-height: 1; }
        .emoji-picker {
            display: none;
            position: absolute;
            top: 50px;
            right: 0;
            background: rgba(0,0,0,0.95);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 8px;
            border-radius: 8px;
            z-index: 200;
            width: max-content;
            box-shadow: 0 6px 20px rgba(0,0,0,0.6);
        }
        .emoji-grid { display: grid; grid-template-columns: repeat(8, 1fr); gap: 6px; }
        .emoji-btn { background: transparent; border: none; font-size: 20px; padding: 6px; cursor: pointer; border-radius: 6px; }
        .emoji-btn:hover { background: rgba(255,255,255,0.06); }

        /* Modal / panel for How To Use */
        .how-modal-backdrop {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .how-modal {
            max-width: 560px;
            width: 100%;
            background: rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 16px;
            border-radius: 8px;
            color: #fff;
            box-shadow: 0 6px 30px rgba(0,0,0,0.6);
            position: relative;
        }
        .how-modal h3 { margin-top:0; }
        .how-modal .close { position: absolute; right: 8px; top: 8px; background: transparent; border: none; color: #fff; font-size: 18px; cursor: pointer; padding: 4px; }

        /* Login overlay (GDM3-like) - full viewport */
        #loginOverlay {
            position: fixed;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            background: rgba(0,0,0,0.55);
        }
        .login-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 18px;
            background: rgba(0,0,0,0.65);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 26px 28px;
            border-radius: 12px;
            min-width: 320px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
        }
        .avatar { width: 112px; height: 112px; border-radius: 50%; background: rgba(255,255,255,0.06); display: flex; align-items: center; justify-content: center; font-size: 48px; color: #fff; border: 2px solid rgba(255,255,255,0.06); }
        .login-title { font-size: 18px; color: #fff; opacity: 0.95; }
        .account-btn { width: 260px; display: flex; align-items: center; gap: 12px; padding: 10px 14px; border-radius: 10px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); color: #fff; cursor: pointer; font-size: 16px; }
        .account-btn:hover { background: rgba(255,255,255,0.06); }

        /* Admin panel: centered (replaces prior Name List area) */
        #adminPanel {
            margin: 8px auto 16px auto;
            z-index: 500;
            background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.12);
            padding: 14px;
            border-radius: 8px;
            width: 100%;
            max-width: 520px;
            color: #fff;
            display: none; /* shown only for Administrator */
        }
        #adminPanel h4 { margin: 6px 0; font-size: 14px; }
        #accountsList { list-style: none; padding: 0; margin: 6px 0; max-height: 220px; overflow: auto; }
        #accountsList li { display:flex; justify-content:space-between; gap:8px; align-items:center; padding:6px 4px; border-radius:6px; }
        .remove-account { background: rgba(255,255,255,0.06); border: none; color: #fff; padding: 4px 8px; border-radius:6px; cursor:pointer; }
        .remove-account:hover { background: rgba(255,255,255,0.12); }

        /* Make Administrator remove button hidden/disabled styling */
        .remove-account.disabled {
            opacity: 0.45;
            cursor: not-allowed;
            background: rgba(255,255,255,0.02);
        }

        /* Password prompt area inside login card */
        #passwordArea { display:none; width:100%; gap:8px; flex-direction:column; align-items:stretch; }
        #passwordArea .pw-row { display:flex; gap:8px; align-items:center; }
        #passwordArea input[type="password"] { flex:1; padding:8px; }

        /* Responsive fallback */
        @media (max-width: 640px) {
            .page-inner { margin: 20px; max-width: 100%; }
            #howBtn { left: 8px; top: 8px; }
            .emoji-picker { right: 0; left: 0; width: auto; }
            .emoji-grid { grid-template-columns: repeat(6, 1fr); }
            .login-card { min-width: 260px; padding: 18px; }
            .account-btn { width: 220px; }
            #adminPanel { width: calc(100% - 32px); }
        }
    </style>
</head>
<body>
  <!-- LOGIN OVERLAY: shown first. Background remains visible beneath -->
  <div id="loginOverlay" role="dialog" aria-modal="true" aria-label="Login">
    <div class="login-card" role="presentation">
      <!-- avatar now has an id for JS control and is empty by default -->
      <div id="avatarCircle" class="avatar" aria-hidden="true"></div>
      <div class="login-title" id="loginTitle">Select an account to sign in</div>

      <!-- Dynamic list of accounts from cloud -->
      <div id="accountButtons" style="display:flex; flex-direction:column; gap:8px; align-items:center; width:100%;"></div>

      <!-- Password prompt area that appears when selecting an account -->
      <div id="passwordArea" aria-hidden="true">
        <div id="pwPromptText" style="margin-bottom:4px; color:rgba(255,255,255,0.9); font-size:0.95em;"></div>
        <!-- For entering existing password -->
        <div id="enterPw" style="display:none; gap:8px; flex-direction:column;">
          <input id="passwordInput" type="password" placeholder="Password" autocomplete="new-password" />
          <div style="display:flex; gap:8px;">
            <button id="submitPwBtn">Submit</button>
            <button id="cancelPwBtn" style="background:rgba(255,255,255,0.06); color:#fff;">Cancel</button>
          </div>
        </div>
        <!-- For creating new password -->
        <div id="createPw" style="display:none; gap:8px; flex-direction:column;">
          <input id="newPasswordInput" type="password" placeholder="New password" />
          <input id="newPasswordRetype" type="password" placeholder="Retype new password" />
          <div style="display:flex; gap:8px;">
            <button id="createPwBtn">Create</button>
            <button id="cancelCreateBtn" style="background:rgba(255,255,255,0.06); color:#fff;">Cancel</button>
          </div>
        </div>
      </div>

      <div id="loginHint" style="font-size:0.85em; color:rgba(255,255,255,0.75);">Hover an account to preview initial, click to sign in</div>
    </div>
  </div>

  <!-- Centered page content -->
  <div class="page-inner">
    <!-- Admin panel (now centered, visible only to Administrator after login) -->
    <div id="adminPanel" aria-hidden="true">
      <h4>Accounts (cloud)</h4>
      <div style="display:flex; gap:8px;">
        <input id="newAccountInput" placeholder="New account name" style="flex:1; padding:6px;" />
        <button id="addAccountBtn" style="padding:6px 8px;">Add</button>
      </div>
      <ul id="accountsList" aria-live="polite"></ul>
    </div>

    <!-- How To Use button (keeps its original position relative to page-inner) -->
    <button id="howBtn" title="How To Use">How To Use</button>

    <h2 style="margin-top:6px;">Message Board</h2>

    <select id="nameSelect" required>
        <option value="" disabled selected>Select a name</option>
    </select>
    <br><br>

    <!-- emoji-row: textarea + emoji button + picker -->
    <div class="emoji-row" id="emojiRow">
      <textarea id="messageInput" placeholder="Type a message..."></textarea>

      <!-- emoji button (opens picker) -->
      <button id="emojiBtn" type="button" title="Insert emoji">ðŸ˜Š</button>

      <!-- emoji picker -->
      <div id="emojiPicker" class="emoji-picker" aria-hidden="true">
        <div class="emoji-grid" id="emojiGrid">
          <!-- buttons inserted by JS -->
        </div>
      </div>
    </div>

    <br>
    <button id="sendBtn">Send</button>

    <h2>Message History</h2>
    <button id="clearBtn">Clear Message History (cloud)</button>

    <div id="messages"></div>
  </div>

  <!-- How To Use modal (hidden by default) -->
  <div id="howBackdrop" class="how-modal-backdrop" role="dialog" aria-modal="true">
    <div class="how-modal" role="document">
      <button class="close" id="howClose" aria-label="Close">&times;</button>
      <h3>How To Use</h3>
      <ol>
        <li><u>Administrator</u> should create the accounts in Administrator and save them to the cloud using the Admin panel.</li>
        <li>Each user should then select their name from the dropdown in the "Message Board" section.</li>
        <li>Each user can now use the text box below to send messages to one another, with auto generated separators &amp; timestamps.</li>
      </ol>
      <p>Thank you for using <em>Message Board</em>!</p>
    </div>
  </div>

  <!-- Firebase v12 modular SDK (script type=module) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot,
      setDoc,
      doc,
      deleteDoc,
      getDocs,
      getDoc
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDP7gvu9KT8u37wNEFJ1BUPBBxGKiIUEo8",
      authDomain: "message-history-2d3ab.firebaseapp.com",
      projectId: "message-history-2d3ab",
      storageBucket: "message-history-2d3ab.firebasestorage.app",
      messagingSenderId: "258209489466",
      appId: "1:258209489466:web:fae16998d2b8c161e6cb03",
      measurementId: "G-X3LTVS01X8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM refs
    const nameSelect = document.getElementById('nameSelect');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const messagesDiv = document.getElementById('messages');

    // How-To modal refs
    const howBtn = document.getElementById('howBtn');
    const howBackdrop = document.getElementById('howBackdrop');
    const howClose = document.getElementById('howClose');

    // Emoji refs
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const emojiGrid = document.getElementById('emojiGrid');
    const emojiRow = document.getElementById('emojiRow');

    // LOGIN overlay refs + initial hide of page-inner
    const loginOverlay = document.getElementById('loginOverlay');
    const accountButtons = document.getElementById('accountButtons');
    const pageInner = document.querySelector('.page-inner');
    const adminPanel = document.getElementById('adminPanel');
    const newAccountInput = document.getElementById('newAccountInput');
    const addAccountBtn = document.getElementById('addAccountBtn');
    const accountsList = document.getElementById('accountsList');
    const avatarCircle = document.getElementById('avatarCircle');
    const passwordArea = document.getElementById('passwordArea');
    const pwPromptText = document.getElementById('pwPromptText');
    const enterPw = document.getElementById('enterPw');
    const createPw = document.getElementById('createPw');
    const passwordInput = document.getElementById('passwordInput');
    const submitPwBtn = document.getElementById('submitPwBtn');
    const cancelPwBtn = document.getElementById('cancelPwBtn');
    const newPasswordInput = document.getElementById('newPasswordInput');
    const newPasswordRetype = document.getElementById('newPasswordRetype');
    const createPwBtn = document.getElementById('createPwBtn');
    const cancelCreateBtn = document.getElementById('cancelCreateBtn');
    const loginTitle = document.getElementById('loginTitle');
    const loginHint = document.getElementById('loginHint');

    // hide the message-board UI until login
    pageInner.style.display = 'none';

    // ---------- accounts & passwords doc refs (cloud) ----------
    const accountsDocRef = doc(db, 'meta', 'accounts');
    const passwordsDocRef = doc(db, 'meta', 'passwords');
    const ADMIN_NAME = 'Administrator';

    // Utility: SHA-256 hex hash of a password using SubtleCrypto
    async function hashPassword(password) {
      const enc = new TextEncoder();
      const data = enc.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Ensure accounts doc exists and Administrator remains
    (async function ensureAdminPresent() {
      try {
        const snap = await getDoc(accountsDocRef);
        if (!snap.exists()) {
          await setDoc(accountsDocRef, { list: [ADMIN_NAME] });
        } else {
          const data = snap.data();
          const list = Array.isArray(data?.list) ? data.list : [];
          if (!list.includes(ADMIN_NAME)) {
            const updated = [ADMIN_NAME, ...list];
            await setDoc(accountsDocRef, { list: updated }, { merge: true });
          }
        }
      } catch (err) {
        console.warn("Could not ensure Administrator present (permissions/offline):", err?.message);
      }
    })();

    // Real-time listener for accounts â€” updates login screen, admin panel, and the nameSelect dropdown
    onSnapshot(accountsDocRef, snap => {
      const list = (snap.exists() && Array.isArray(snap.data().list)) ? snap.data().list : [];
      populateAccounts(list);
    }, err => {
      console.error('Accounts listener error (continuing with empty list):', err);
      populateAccounts([]);
    });

    function populateAccounts(list) {
      // Build login overlay account buttons
      accountButtons.innerHTML = "";
      const safeList = Array.isArray(list) ? list.slice() : [];
      if (safeList.length === 0) {
        appendAccountButton(ADMIN_NAME);
      } else {
        if (!safeList.includes(ADMIN_NAME)) safeList.unshift(ADMIN_NAME);
        const seen = new Set();
        const unique = [];
        for (const n of safeList) {
          if (!seen.has(n)) { seen.add(n); unique.push(n); }
        }
        unique.forEach(name => appendAccountButton(name));
      }

      // Build admin panel list
      accountsList.innerHTML = "";
      if (Array.isArray(list)) {
        const ordered = list.includes(ADMIN_NAME) ? [ADMIN_NAME, ...list.filter(n => n !== ADMIN_NAME)] : list;
        ordered.forEach(name => {
          const li = document.createElement('li');
          const label = document.createElement('span');
          label.textContent = name;
          li.appendChild(label);

          if (name === ADMIN_NAME) {
            const rm = document.createElement('button');
            rm.className = 'remove-account disabled';
            rm.textContent = 'Remove';
            rm.title = 'Administrator cannot be removed';
            rm.disabled = true;
            li.appendChild(rm);
          } else {
            const rm = document.createElement('button');
            rm.className = 'remove-account';
            rm.textContent = 'Remove';
            rm.addEventListener('click', async () => {
              if (!confirm(`Remove account "${name}" from cloud? This will remove it for everyone.`)) return;
              try {
                const snap = await getDoc(accountsDocRef);
                const existing = (snap.exists() && Array.isArray(snap.data().list)) ? snap.data().list : [];
                const filtered = existing.filter(n => n !== name && n !== undefined && n !== null);
                if (!filtered.includes(ADMIN_NAME)) filtered.unshift(ADMIN_NAME);
                await setDoc(accountsDocRef, { list: filtered }, { merge: true });
                // also remove any password entry for that account (if exists)
                try {
                  const pwSnap = await getDoc(passwordsDocRef);
                  if (pwSnap.exists()) {
                    const map = pwSnap.data().map || {};
                    if (map[name]) {
                      delete map[name];
                      await setDoc(passwordsDocRef, { map }, { merge: true });
                    }
                  }
                } catch (err) {
                  console.warn('Could not remove password entry:', err?.message);
                }
              } catch (err) {
                alert('Failed to remove account: ' + err.message);
              }
            });
            li.appendChild(rm);
          }
          accountsList.appendChild(li);
        });
      }

      // Populate the nameSelect dropdown from the accounts list
      nameSelect.innerHTML = "";
      const placeholder = document.createElement('option');
      placeholder.value = "";
      placeholder.disabled = true;
      placeholder.selected = true;
      placeholder.textContent = "Select a name";
      nameSelect.appendChild(placeholder);

      const finalList = Array.isArray(list) ? list.slice() : [];
      if (!finalList.includes(ADMIN_NAME)) finalList.unshift(ADMIN_NAME);
      const seen2 = new Set();
      for (const n of finalList) {
        if (!n || seen2.has(n)) continue;
        seen2.add(n);
        const opt = document.createElement('option');
        opt.value = n;
        opt.textContent = n;
        nameSelect.appendChild(opt);
      }
    }

    function appendAccountButton(name) {
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'account-btn';
      b.textContent = name;

      // Hover behavior: show capitalized initial in avatarCircle while hovered
      b.addEventListener('mouseenter', () => {
        // only show when not in password flow
        if (!passwordFlow.active) {
          const ch = (name && typeof name === 'string') ? name.trim().charAt(0).toUpperCase() : '';
          avatarCircle.textContent = ch;
        }
      });
      b.addEventListener('mouseleave', () => {
        // clear avatar only if not in password flow and not selected
        if (!passwordFlow.active) avatarCircle.textContent = '';
      });

      b.addEventListener('click', () => {
        // start password flow for this account
        startPasswordFlowFor(name);
      });
      accountButtons.appendChild(b);
    }

    // Add account button handler (admin panel)
    addAccountBtn.addEventListener('click', async () => {
      const v = (newAccountInput.value || "").trim();
      if (!v) return;
      if (v === ADMIN_NAME) {
        alert('Administrator already always exists.');
        newAccountInput.value = '';
        return;
      }
      try {
        const snap = await getDoc(accountsDocRef);
        const existing = (snap.exists() && Array.isArray(snap.data().list)) ? snap.data().list : [];
        if (existing.includes(v)) {
          alert('Account already exists.');
          return;
        }
        const updated = existing.includes(ADMIN_NAME) ? [...existing, v] : [ADMIN_NAME, ...existing, v];
        await setDoc(accountsDocRef, { list: updated }, { merge: true });
        newAccountInput.value = '';
      } catch (err) {
        alert('Failed to add account: ' + err.message);
      }
    });

    // login state
    let currentUser = null;

    // Track password flow state
    const passwordFlow = {
      active: false,
      account: null,
      mode: null // 'enter' or 'create'
    };

    async function startPasswordFlowFor(accountName) {
      passwordFlow.active = true;
      passwordFlow.account = accountName;
      passwordFlow.mode = null;
      // hide account buttons but keep card & avatar
      accountButtons.style.display = 'none';
      passwordArea.style.display = 'flex';
      passwordArea.setAttribute('aria-hidden', 'false');
      loginHint.textContent = ''; // hide hint

      // set avatar to selected initial and keep it
      avatarCircle.textContent = (accountName && typeof accountName === 'string') ? accountName.trim().charAt(0).toUpperCase() : '';

      // Decide if password exists in cloud for this account
      pwPromptText.textContent = `Sign in as ${accountName}`;
      try {
        const pwSnap = await getDoc(passwordsDocRef);
        const map = (pwSnap.exists() && pwSnap.data().map) ? pwSnap.data().map : {};
        if (map && map[accountName]) {
          // password exists â†’ show Enter password UI
          passwordFlow.mode = 'enter';
          enterPw.style.display = 'flex';
          createPw.style.display = 'none';
          passwordInput.value = '';
          passwordInput.focus();
        } else {
          // no password set â†’ prompt to create
          passwordFlow.mode = 'create';
          enterPw.style.display = 'none';
          createPw.style.display = 'flex';
          newPasswordInput.value = '';
          newPasswordRetype.value = '';
          newPasswordInput.focus();
        }
      } catch (err) {
        // on error, default to create (safer)
        passwordFlow.mode = 'create';
        enterPw.style.display = 'none';
        createPw.style.display = 'flex';
      }
    }

    // Cancel handlers: return to account list, clear avatar
    cancelPwBtn.addEventListener('click', () => {
      endPasswordFlow();
    });
    cancelCreateBtn.addEventListener('click', () => {
      endPasswordFlow();
    });

    function endPasswordFlow() {
      passwordFlow.active = false;
      passwordFlow.account = null;
      passwordFlow.mode = null;
      passwordArea.style.display = 'none';
      passwordArea.setAttribute('aria-hidden', 'true');
      accountButtons.style.display = 'flex';
      avatarCircle.textContent = '';
      loginHint.textContent = 'Hover an account to preview initial, click to sign in';
      pwPromptText.textContent = '';
    }

    // Create password: validate and write hashed password to cloud then login
    createPwBtn.addEventListener('click', async () => {
      const p1 = (newPasswordInput.value || '').trim();
      const p2 = (newPasswordRetype.value || '').trim();
      if (!p1 || !p2) {
        alert('Please enter and retype the new password.');
        return;
      }
      if (p1 !== p2) {
        alert('Passwords do not match.');
        return;
      }
      const acct = passwordFlow.account;
      try {
        const hashed = await hashPassword(p1);
        // write to passwords doc under map[acct] = hashed
        const snap = await getDoc(passwordsDocRef);
        const existingMap = (snap.exists() && snap.data().map) ? snap.data().map : {};
        existingMap[acct] = hashed;
        await setDoc(passwordsDocRef, { map: existingMap }, { merge: true });
        // login
        finishLoginAs(acct);
      } catch (err) {
        alert('Failed to set password: ' + (err.message || err));
      }
    });

    // Submit existing password: hash and compare
    submitPwBtn.addEventListener('click', async () => {
      const p = (passwordInput.value || '').trim();
      if (!p) {
        alert('Please enter your password.');
        return;
      }
      const acct = passwordFlow.account;
      try {
        const hashed = await hashPassword(p);
        const pwSnap = await getDoc(passwordsDocRef);
        const map = (pwSnap.exists() && pwSnap.data().map) ? pwSnap.data().map : {};
        const stored = map[acct] || null;
        if (!stored) {
          alert('No password stored for this account (it may have been removed). Please create one.');
          // switch to create mode
          passwordFlow.mode = 'create';
          enterPw.style.display = 'none';
          createPw.style.display = 'flex';
          return;
        }
        if (hashed === stored) {
          finishLoginAs(acct);
        } else {
          alert('Incorrect password. Try again.');
          passwordInput.value = '';
          passwordInput.focus();
        }
      } catch (err) {
        alert('Failed to verify password: ' + (err.message || err));
      }
    });

    // Helper to finish login and show main UI
    function finishLoginAs(accountName) {
      currentUser = accountName;
      // hide overlay, show page
      loginOverlay.style.display = 'none';
      pageInner.style.display = '';
      // show admin panel only for Administrator
      if (currentUser === ADMIN_NAME) {
        adminPanel.style.display = 'block';
        adminPanel.setAttribute('aria-hidden', 'false');
      } else {
        adminPanel.style.display = 'none';
        adminPanel.setAttribute('aria-hidden', 'true');
      }

      // --- NEW: enforce send-as restriction ---
      if (currentUser === ADMIN_NAME) {
        // Admin can send as anyone -> keep select enabled
        nameSelect.disabled = false;
        // Do not auto-select an account for admin; keep previous selection or placeholder
      } else {
        // Non-admin: lock send identity to currentUser
        // Ensure dropdown contains the current user, select it, and disable the dropdown
        let found = false;
        for (let i = 0; i < nameSelect.options.length; i++) {
          if (nameSelect.options[i].value === accountName) {
            nameSelect.selectedIndex = i;
            found = true;
            break;
          }
        }
        if (!found) {
          const opt = document.createElement('option');
          opt.value = accountName;
          opt.textContent = accountName;
          nameSelect.appendChild(opt);
          nameSelect.value = accountName;
        }
        nameSelect.disabled = true;
      }

      // focus message area for quick sending
      messageInput.focus();

      // clear password flow UI state
      passwordArea.style.display = 'none';
      accountButtons.style.display = 'flex'; // keep consistent for next login
      passwordFlow.active = false;
      passwordFlow.account = null;
      passwordFlow.mode = null;
      avatarCircle.textContent = '';
      loginHint.textContent = 'Hover an account to preview initial, click to sign in';
      pwPromptText.textContent = '';
    }

    // -------------------- Messages (collection: messages) --------------------
    const messagesCol = collection(db, 'messages');
    const messagesQuery = query(messagesCol, orderBy('time', 'asc'));

    // realtime listener for messages
    onSnapshot(messagesQuery, snapshot => {
      const msgs = [];
      snapshot.forEach(docSnap => {
        const d = docSnap.data();
        msgs.push({
          id: docSnap.id,
          name: d.name,
          text: d.text || "",
          time: d.time || null
        });
      });
      renderMessages(msgs);
    }, err => {
      console.error("Realtime messages error:", err);
    });

    // Render messages such that each timestamp separates authors and corresponds to the block BELOW it
    function renderMessages(messages) {
      messagesDiv.innerHTML = "";
      if (messages.length === 0) return;

      const topTime = formatTimestamp(messages[0].time);
      messagesDiv.appendChild(createTimestampRow(topTime));

      messages.forEach((m, i) => {
        const div = document.createElement('div');
        div.className = 'message';
        div.style.background = colorForName(m.name);

        const nameSpan = document.createElement('span');
        nameSpan.className = 'name';
        nameSpan.textContent = (m.name || "") + ': ';

        div.appendChild(nameSpan);
        div.appendChild(document.createTextNode(m.text));
        messagesDiv.appendChild(div);

        if (i < messages.length - 1 && messages[i].name !== messages[i + 1].name) {
          const nextTime = formatTimestamp(messages[i + 1].time);
          messagesDiv.appendChild(createTimestampRow(nextTime));
        }
      });

      if (messagesDiv.lastElementChild) {
        messagesDiv.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
      }
    }

    function createTimestampRow(text) {
      const row = document.createElement('div');
      row.className = 'timestamp-row';
      const left = document.createElement('div'); left.className = 'line';
      const mid = document.createElement('div'); mid.className = 'timestamp-text'; mid.textContent = text || '';
      const right = document.createElement('div'); right.className = 'line';
      row.appendChild(left); row.appendChild(mid); row.appendChild(right);
      return row;
    }

    function formatTimestamp(thing) {
      if (!thing) return "";
      let d;
      if (typeof thing === 'string') d = new Date(thing);
      else if (thing && typeof thing.toDate === 'function') d = thing.toDate();
      else if (thing instanceof Date) d = thing;
      else d = new Date();
      if (isNaN(d)) return "";
      const month = d.getMonth() + 1;
      const day = d.getDate();
      const year = d.getFullYear();
      let hour = d.getHours();
      const minute = d.getMinutes().toString().padStart(2, '0');
      const ampm = hour >= 12 ? 'PM' : 'AM';
      hour = hour % 12;
      if (hour === 0) hour = 12;
      return `${month}/${day}/${year} ${hour}:${minute} ${ampm}`;
    }

    // -------------------- Retention --------------------
    async function enforceRetention() {
      try {
        const snap = await getDocs(messagesQuery);
        const total = snap.size;
        if (total > 100) {
          const numToDelete = total - 10;
          const docsToDelete = snap.docs.slice(0, numToDelete);
          const deletes = docsToDelete.map(d => deleteDoc(doc(db, 'messages', d.id)));
          await Promise.all(deletes);
        }
      } catch (err) {
        console.error('Retention enforcement failed:', err);
      }
    }

    // -------------------- Add message --------------------
    sendBtn.addEventListener('click', addMessage);
    messageInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        addMessage();
      }
    });

    async function addMessage() {
      // IMPORTANT: if logged in as a normal user, force the name to currentUser
      let sendName;
      if (currentUser && currentUser !== ADMIN_NAME) {
        sendName = currentUser;
      } else {
        // Admin or not logged in fallback - use selected name
        sendName = (nameSelect.value || "").trim();
      }

      const text = (messageInput.value || "").trim();
      if (!sendName || !text) return;

      try {
        await addDoc(messagesCol, {
          name: sendName,
          text,
          time: serverTimestamp()
        });
        messageInput.value = "";
        await enforceRetention();
      } catch (err) {
        alert("Failed to send message: " + err.message);
      }
    }

    // -------------------- Clear messages (cloud) --------------------
    clearBtn.addEventListener('click', async () => {
      if (!confirm("Delete all messages from cloud? This cannot be undone.")) return;
      try {
        const snap = await getDocs(messagesCol);
        const deletes = [];
        snap.forEach(d => deletes.push(deleteDoc(doc(db, 'messages', d.id))));
        await Promise.all(deletes);
      } catch (err) {
        alert("Failed to clear messages: " + err.message);
      }
    });

    // -------------------- Bootstrap: nothing local for names now; accounts drive nameSelect --------------------
    (function init() {
      // accounts onSnapshot will populate nameSelect; nothing else needed here
    })();
  </script>

</body>
</html>
